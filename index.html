<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Граф лорбука</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #graph { width: 100%; height: 800px; border: 1px solid lightgray; }
        .node-tooltip {
            word-wrap: break-word;
            max-width: 200px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h2>Загрузите JSON лорбука</h2>
    <input type="file" id="jsonInput" accept=".json">
    <div id="graph"></div>

    <script>
        document.getElementById('jsonInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const lorebook = JSON.parse(event.target.result);
                visualizeGraph(lorebook);
            };
            reader.readAsText(file);
        });

        function visualizeGraph(lorebook) {
            const nodes = [];
            const edges = [];
            const entryMap = {};

            // Добавляем ноды
            for (const key in lorebook.entries) {
                const entry = lorebook.entries[key];
                const content = entry.content ? entry.content : '';
                const keys = entry.key ? entry.key.join(', ') : '';
                const keysSecondary = entry.keysecondary ? entry.keysecondary.join(', ') : '';
                const comment = entry.comment || key;

                const title = `<div class="node-tooltip">Name: ${comment}<br>Content: ${content}<br>Keys: ${keys}<br>KeySecondary: ${keysSecondary}</div>`;
                nodes.push({
                    id: comment,
                    label: comment,
                    title: title,
                    shape: "box",
                    borderRadius: 10
                });
                entryMap[comment] = entry;
            }

            // Добавляем рёбра по общим ключам
            const entries = Object.values(entryMap);
            for (let i = 0; i < entries.length; i++) {
                for (let j = i + 1; j < entries.length; j++) {
                    const keys1 = new Set(entries[i].key || []);
                    const keys2 = new Set(entries[j].key || []);
                    const commonKeys = [...keys1].filter(k => keys2.has(k));
                    for (const key of commonKeys) {
                        edges.push({
                            from: entries[i].comment,
                            to: entries[j].comment,
                            label: key,
                            title: key
                        });
                    }
                }
            }

            const container = document.getElementById('graph');
            const data = {nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges)};
            const options = {
                nodes: {
                    shape: "box",
                    borderRadius: 10,
                    font: {size: 14}
                },
                edges: {
                    arrows: {to: true},
                    font: {size: 10, align: "top"}
                },
                physics: {
                    enabled: true,
                    barnesHut: {
                        gravitationalConstant: -1000,
                        centralGravity: 0.3,
                        springLength: 200,
                        springConstant: 0.02
                    }
                }
            };
            new vis.Network(container, data, options);
        }
    </script>
</body>
</html>
